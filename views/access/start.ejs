<!DOCTYPE html>
<html ng-app="app">
    <head>
        <title>DogeMate</title>
        <%- include('../_partials/_header') %>
        <%- include('../_partials/access/_footer') %>
    </head>
    <body>
        <%- include('navigation') %>
        <ng-view></ng-view>

        <!-- DogeMate Especialista Login -->
        <script type="text/ng-template" id="/login.html">
            <div class="container">
                <div class="page-header">
                    <h1>Acceso</h1>
                </div>
                <div class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-3 control-label" for="_email">Email</label>
                        <div class="col-sm-4">
                            <input type="text" class="form-control" id="_email" ng-model="especialista._email" required="required"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label" for="password">Contrase&ntilde;a</label>
                        <div class="col-sm-4">
                            <input type="password" class="form-control" id="password" ng-model="especialista.password" required="required"/>
                        </div>
                    </div>
                    <div class="col-sm-4 col-sm-offset-3">
                        <div class="btn-group btn-group-justified" role="group" aria-label="...">
                            <div class="btn-group" role="group">
                                <a class="btn btn-info
                                " href="#/registro">Registrarse</a>
                            </div>
                            <div class="btn-group" role="group">
                                <button type="submit" class="btn btn-success" ng-model="especialista" ng-click="find()">Entrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </script>

        <script type="text/ng-template" id="/registro.html">
            <div class="container">
                <div class="page-header">
                    <h1>Registro</h1>
                </div>
                <div class="form-horizontal">
                    <div class="form-group">
                        <label class="col-md-3 col-sm-4 control-label" for="email">Email</label>
                        <div class="col-sm-8 col-md-4">
                            <input type="text" class="form-control" id="email" ng-model="nuevoEspecialista.email" required="required"/>
                            <span id="emailAlert"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 col-sm-4 control-label">Contrase&ntilde;a</label>
                        <div class="col-sm-8 col-md-4">
                            <input type="password" class="form-control" id="contrasena" ng-model="nuevoEspecialista.contrasena" required="required" />
                            <span id="passwordAlert"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 col-sm-4 control-label" for="confirmacion">Confirmar contrase&ntilde;a</label>
                        <div class="col-sm-8 col-md-4">
                            <input type="password" class="form-control" id="confirmacion" required="required"/>
                            <span id="passwordConfirmationAlert"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 col-sm-4 control-label" for="nombre">Nombre</label>
                        <div class="col-sm-8 col-md-4">
                            <input type="text" class="form-control" id="nombre" required="required" ng-model="nuevoEspecialista.nombre"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 col-sm-4 control-label" for="apellido_p">Apellido paterno</label>
                        <div class="col-sm-8 col-md-4">
                            <input type="text" class="form-control" id="apellido_p" required="required" ng-model="nuevoEspecialista.apellido_p"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 col-sm-4 control-label" for="apellido_m">Apellido materno</label>
                        <div class="col-sm-8 col-md-4">
                            <input type="text" class="form-control" id="apellido_m" required="required" ng-model="nuevoEspecialista.apellido_m"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 col-sm-4 control-label" for="datepicker">Fecha de nacimiento</label>
                        <div class="col-sm-8 col-md-4">
                            <input type="text" class="form-control" id="datepicker" required="required" ng-model="nuevoEspecialista.fecha_nac"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 col-sm-4 control-label" for="celular">Celular</label>
                        <div class="col-sm-8 col-md-4">
                            <input type="text" class="form-control" id="celular" required="required" ng-model="nuevoEspecialista.celular" maxlength="10"/>
                            <span id="celularAlert"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 col-sm-4 control-label" for="peso">Peso</label>
                        <div class="col-sm-3 col-md-2">
                            <input type="text" class="form-control" id="peso" required="required" ng-model="nuevoEspecialista.peso" placeholder="65.00" maxlength="5"/>
                        </div>
                        <span class="col-sm-1 col-md-1 control-label">Kilogramos</span>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 col-sm-4 control-label" for="estatura">Estatura</label>
                        <div class="col-sm-3 col-md-2">
                            <input type="text" class="form-control" id="estatura" required="required" ng-model="nuevoEspecialista.estatura" placeholder="1.70" maxlength="5"/>
                        </div>
                        <span class="col-sm-1 col-md-1 control-label">Metros</span>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 col-sm-4 control-label">Fotografía</label>
                        <div class="col-md-3 col-sm-4">
                            <input type="file" id="fotografia" ng-model="nuevoEspecialista.fotografia" />
                            <span id="fotografiaAlert"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-3 col-md-offset-3 col-sm-4 col-sm-offset-4">
                            <img src="/images/profile.jpg" id="photoPreview" alt="Preview" width="100%"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-2 col-md-offset-5 col-sm-4 col-sm-offset-6">
                            <div class="btn-group btn-group-justified" role="group" aria-label="...">
                                <div class="btn-group" role="group">
                                    <button type="submit" class="btn btn-success" ng-model="nuevoEspecialista" ng-click="save(nuevoEspecialista)">Enviar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </script>

        <script type="text/javascript">
            angular.module('app', ['ngRoute', 'ngResource'])
                .factory('Especialistas', ['$resource', function($resource) {
                    var e = $resource('/especialistas/:_email', null, {
                        'update': { method: 'PUT' }
                    });
                    return e;
                }])
                .controller('RegistroController', ['$scope', 'Especialistas', function($scope, Especialistas) {
                    $scope.especialistas = Especialistas.query();
                    
                    // Email validation
                    $('#email').keyup(function emailValidation() {
                        var email = $("#email").val();
                        var regex = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                        if(regex.test(email)) {
                            $('#emailAlert').html('Email válido.');
                            $('#emailAlert').css('color', 'green');
                        } else {
                            $('#emailAlert').html('<strong>Error</strong>: Verifique que su correo electrónico esté escrito correctamente: ' + email);
                            $('#emailAlert').css('color', 'red');
                        }
                    });

                    // Password validation
                    $('#contrasena').keyup(function passwordConforms() {
                        var pwd = $('#contrasena').val();
                        if (pwd.length < 8) {
                            $('#passwordAlert').html('<strong>Error</strong>: La contaseña introducida debe contener al menos 8 caracteres.');
                            $('#passwordAlert').css('color', 'red');
                        } else if(pwd.length > 16) {
                            $('#passwordAlert').html('<strong>Error</strong>: La contaseña introducida debe contener máximo 16 caracteres.');
                            $('#passwordAlert').css('color', 'red');
                        } else {
                            $('#passwordAlert').html('Contraseña válida.');
                            $('#passwordAlert').css('color', 'green');
                        }
                    });

                    // Password match validation
                    $('#confirmacion').keyup(function passwordValidation() {
                        var pwd = $('#contrasena').val();
                        var conf = $('#confirmacion').val();
                        if(pwd===conf) {
                            $('#passwordConfirmationAlert').html('Las contrase&ntilde;as coinciden.');
                            $('#passwordConfirmationAlert').css('color', 'green');
                        } else {
                            $('#passwordConfirmationAlert').html('<strong>Error</strong>: Las contrase&ntilde;as no coinciden.');
                            $('#passwordConfirmationAlert').css('color', 'red');
                        }
                    });

                    // Number field validation
                    $('#celular').keyup(function phoneValidation() {
                        var celular = $('#celular').val();
                        var regex = /^\d+$/;
                        if($('#celular').val().match(regex) && celular.length === 10) {
                            $('#celularAlert').html('Número de celular válido.');
                            $('#celularAlert').css('color', 'green');
                        } else {
                            $('#celularAlert').html('<strong>Error</strong>: El número celular introducido no es válido.');
                            $('#celularAlert').css('color', 'red');
                        }
                    });

                    // Datepicker activation and setup
                    $('#datepicker').datepicker({
                        defaultDate: "-18y", 
                        navigationAsDateFormat: true, 
                        changeYear: true
                    });

                    // Image file validation
                    $('#fotografia').change(function() {
                        var image = $('#fotografia').val();
                        var type = image.replace(/^.*\./, '');
                        var ValidImageTypes = ["gif", "jpeg", "png", "jpg"];
                        if($.inArray(type, ValidImageTypes) < 0) {
                            $('#fotografiaAlert').html('<strong>Error</strong>: Error, la imágen no es válida.');
                            $('#fotografiaAlert').css('color', 'red');
                        } else {
                            $('#fotografiaAlert').html('Fotografía válida.');
                            $('#fotografiaAlert').css('color', 'green');
                            preview(this);
                        }
                    });

                    // Specialist photo preview
                    function preview(input) {
                        if(input.files && input.files[0]) {
                            var reader = new FileReader();
                            reader.onload = function(e) {
                                $('#photoPreview').attr('src', e.target.result);
                            }
                            reader.readAsDataURL(input.files[0]);
                        } else {
                            console.log('Error: Couldn\'t load picture..');
                        }
                    }
                    
                    // Save specialist into Mongo
                    $scope.save = function(nuevoEspecialista) {
                        var email = $scope.nuevoEspecialista.email;
                        var contrasena = $scope.nuevoEspecialista.contrasena;
                        console.log('Email: ' + email);
                        if(!$scope.nuevoEspecialista || $scope.nuevoEspecialista.length < 1) {
                            console.log('Please introduce specialista variables..');
                            return;
                        }
                        console.log('Creating specialist...');
                        var especialista = new Especialistas({
                            email: nuevoEspecialista.email,
                            contrasena: nuevoEspecialista.contrasena
                        });
                        especialista.$save(function() {
                            $scope.especialistas.push(especialista);
                            $scope.newEspecialista = '';
                        });
                        
                    }
                    
                }])
                .controller('LoginController', ['$scope', '$routeParams', 'Especialistas', '$location', function($scope, $routeParams, Especialistas, $location) {
                    $scope.especialista = Especialistas.get({
                        id: $routeParams.id
                    });
                    $scope.find = function() {
                        Especialista.get({
                            email: $scope.especialista._email,
                            contrasena: $scope.especialista.password
                        }, $scope.especialista, function() {
                            $location.url('/');
                            console.log('buscando especialista...');
                        });
                    };
                }])
                .config(['$routeProvider', function($routeProvider) {
                    $routeProvider.when('/registro', {
                        templateUrl: '/registro.html',
                        controller: 'RegistroController'
                    }).when('/', {
                        templateUrl: '/login.html',
                        controller: 'LoginController'
                    });
                }]);

        </script>
    </body>
</html>